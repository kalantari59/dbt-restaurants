name: dbt CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  dbt:
    runs-on: ubuntu-latest
    env:
      # dbt will read this folder for profiles.yml
      DBT_PROFILES_DIR: ${{ github.workspace }}/.dbt
      # Database connection settings from GitHub Secrets
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_PORT: ${{ secrets.DB_PORT }}
      DB_NAME: ${{ secrets.DB_NAME }}
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
    steps:
      # Check out the repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Set up Python runtime
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Install dbt with the Postgres adapter
      - name: Install dbt
        run: |
          python -m pip install --upgrade pip
          pip install dbt-core dbt-postgres

      # Create a dbt profile using environment variables
      - name: Create dbt profile
        run: |
          mkdir -p "${DBT_PROFILES_DIR}"
          cat > "${DBT_PROFILES_DIR}/profiles.yml" << 'EOF'
          toronto_restaurants:
            target: ci
            outputs:
              ci:
                type: postgres
                host: "{{ env_var('DB_HOST') }}"
                port: "{{ env_var('DB_PORT') | int }}"
                user: "{{ env_var('DB_USER') }}"
                password: "{{ env_var('DB_PASSWORD') }}"
                dbname: "{{ env_var('DB_NAME') }}"
                schema: public
                threads: 4
                keepalives_idle: 0
          EOF

      # Install dbt dependencies (packages.yml if present)
      - name: dbt deps
        run: dbt deps

      # Seed raw CSV data into the database
      - name: dbt seed
        run: dbt seed

      # Run all models
      - name: dbt run
        run: dbt run

      # Run tests
      - name: dbt test
        run: dbt test
